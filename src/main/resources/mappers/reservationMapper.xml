<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 예약 네임스페이스(사용영역) 설정 -->
<mapper namespace="com.gsitm.mrs.mappers.ReservationMapper">
	<sql id="roomInfo_columns">
		roomNo, roomName, roomName, workplaceName, workplaceAddress, capacity, nwAvailable, image, adminName
	</sql>
	
	<!-- 마이페이지 예약현황 조회 -->
	<select id="getReservationInfo" resultType="Reservation">
		SELECT res_no as reservationNo, emp_no as employeeNo, room_no as roomNo, name, purpose, TO_CHAR(start_date, 'YYYY-MM-DD') as startDate, TO_CHAR(end_date, 'YYYY-MM-DD') as endDate, snack_want as snackWant, status
		FROM Reservation
		WHERE emp_no=#{employeeNo}
	</select>
	
	<!-- TO_CHAR("start", 'YYYY-MM-DD') as startDate,  TO_CHAR("end", 'YYYY-MM-DD') as endDate-->

	<!-- 승인 대기 목록 조회 -->
	<select id="getWaitingList" resultType="Map">
		SELECT r.res_no         AS reservationNo, 
		       w.mgr_approval   AS managerApproval, 
		       w.admin_approval AS adminApproval, 
		       r.name           AS resName, 
		       r.purpose, 
		       room.name        AS roomName, 
		       r.start_date		AS startDate, 
		       r.end_date 		AS endDate,
		       e.name           AS empName, 
		       e2.name          AS mgrName
		FROM   waiting w, 
		       reservation r, 
		       room room, 
		       employee e, 
		       employee e2 
		WHERE  w.res_no = r.res_no 
		       AND r.room_no = room.room_no 
		       AND r.emp_no = e.emp_no 
		       AND e.mgr_no = e2.emp_no 
		       AND ( w.mgr_approval = 'W' 
		              OR w.admin_approval = 'W' ) 
	</select>
	
	<!-- 회의실 정보 조회 -->
	<select id="getRoomInfo" parameterType="int" resultType="Map">
		SELECT <include refid="roomInfo_columns"/>, 
       			LISTAGG(equipmentName,', ') WITHIN GROUP(ORDER BY roomNo) AS equipments       		
		FROM  (SELECT room.room_no      AS roomNo, 
		              room.name         AS roomName, 
		              workplace.name    AS workplaceName, 
		              workplace.address AS workplaceAddress, 
		              room.capacity, 
		              room.nw_available AS nwAvailable, 
		              room.image, 
		              employee.name     AS adminName, 
		              equipment.name    AS equipmentName 
		       FROM   room, 
		              workplace, 
		              employee, 
		              ADMIN, 
		              equipment 
		       WHERE  room.workplace_no = workplace.workplace_no 
		              AND room.admin_id = ADMIN.admin_id 
		              AND ADMIN.emp_no = employee.emp_no 
		              AND room.room_no = equipment.room_no(+) 
		              AND room.room_no = #{roomNo}) 
		GROUP  BY <include refid="roomInfo_columns"/>
	</select>
	
	<select id="getRoomList" parameterType="int" resultType="Map">
		SELECT <include refid="roomInfo_columns"/>, 
       			LISTAGG(equipmentName,', ') WITHIN GROUP(ORDER BY roomNo)        		
		FROM  (SELECT room.room_no      AS roomNo, 
		              room.name         AS roomName, 
		              workplace.name    AS workplaceName, 
		              workplace.address AS workplaceAddress, 
		              room.capacity, 
		              room.nw_available AS nwAvailable, 
		              room.image, 
		              employee.name     AS adminName, 
		              equipment.name    AS equipmentName 
		       FROM   room, 
		              workplace, 
		              employee, 
		              ADMIN, 
		              equipment 
		       WHERE  room.workplace_no = workplace.workplace_no 
		              AND room.admin_id = ADMIN.admin_id 
		              AND ADMIN.emp_no = employee.emp_no 
		              AND room.room_no = equipment.room_no(+) 
		              AND room.workplace_no = #{workplaceNo}) 
		GROUP  BY <include refid="roomInfo_columns"/>
	</select>
	
	<!-- 회의실 비품 목록 조회 -->
	<select id="getEquipmentList" parameterType="int" resultType="Map">
		SELECT *
		FROM equipment
		JOIN room
		USING(room_no)
		WHERE room_no=#{roomNo}
	</select>
</mapper>